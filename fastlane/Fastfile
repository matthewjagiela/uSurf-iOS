# Fastfile

default_platform(:ios)

platform :ios do
  lane :test do
    # Run unit tests
    run_tests(scheme: "uSurfTests")
  end

  lane :deploy do
    # Download the provisioning profile from the Apple Developer Portal
    match(
      type: "appstore",
      app_identifier: "com.uapps.uSurf",
      readonly: true,
      force: true,
      username: ENV["APP_STORE_CONNECT_USERNAME"],
      team_id: ENV["APP_STORE_CONNECT_TEAM_ID"],
      api_key: ENV["APP_STORE_CONNECT_API_KEY"]
    )

    # Get version number from Info.plist
    version_number = get_version_number(xcodeproj: "uSurf.xcodeproj")

    # Increment build number
    increment_build_number(xcodeproj: "uSurf.xcodeproj")

    # Build the app
    build_app(scheme: "uSurf", export_method: "app-store")

    # Upload to App Store Connect
    upload_to_app_store(
      ipa: "uSurf.ipa",
      app_identifier: "com.uapps.uSurf",
      api_key: ENV["APP_STORE_CONNECT_API_KEY"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      team_id: ENV["APP_STORE_CONNECT_TEAM_ID"],
      version: version_number,
      build_number: ENV["BUILD_NUMBER"]
    )
  end
end
